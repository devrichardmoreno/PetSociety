<section id="appointment-doctor-history-container-all"
         [style.padding-top.px]="headerHeight + 10">
    <main id="main-content">
        <h1 class="page-title">Historial de Citas</h1>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="filter-group">
                <label for="pet-filter">Mascota:</label>
                <select id="pet-filter" [(ngModel)]="selectedPetId" (change)="onPetFilterChange(selectedPetId)" class="filter-select">
                    <option value="ALL">Todas</option>
                    @for (pet of uniquePets; track pet.id) {
                        <option [value]="pet.id">{{ pet.name }}</option>
                    }
                </select>
            </div>

            <div class="filter-group">
                <label for="client-filter">Cliente:</label>
                <select id="client-filter" [(ngModel)]="selectedClientName" (change)="onClientFilterChange(selectedClientName)" class="filter-select">
                    <option value="ALL">Todos</option>
                    @for (client of uniqueClients; track client) {
                        <option [value]="client">{{ client }}</option>
                    }
                </select>
            </div>

            <div class="filter-group">
                <label for="date-filter">Fecha:</label>
                <input id="date-filter" 
                       type="date" 
                       [(ngModel)]="selectedDate" 
                       (change)="onDateFilterChange()" 
                       class="filter-input">
            </div>

            <div class="filter-group">
                <label for="reason-filter">Motivo:</label>
                <select id="reason-filter" [(ngModel)]="selectedReason" (change)="onReasonFilterChange(selectedReason)" class="filter-select">
                    <option value="ALL">Todos</option>
                    <option [value]="Reason.CONTROL">Control</option>
                    <option [value]="Reason.EMERGENCY">Emergencia</option>
                    <option [value]="Reason.VACCINATION">Vacunación</option>
                    <option [value]="Reason.NUTRITION">Nutrición</option>
                </select>
            </div>

            <div class="filter-group">
                <button class="btn-clear-filters" (click)="clearFilters()">Limpiar filtros</button>
            </div>
        </div>

        <!-- Listado de citas -->
        @if (displayedAppointments.length === 0) {
            <div class="empty-message">
                <p>No se encontraron citas con los filtros seleccionados</p>
            </div>
        } @else {
            <div class="cards-container">
                @for (appointment of displayedAppointments; track appointment.appointmentId) {
                    <article class="appointment-card" role="article" aria-label="Cita {{ appointment.appointmentId }}" (click)="openAppointmentDetails(appointment)">
                        <div class="appointment-card-header">
                            <h3 class="appointment-card-title">{{ getFullPetDisplay(appointment) }}</h3>
                            <div class="appointment-card-date">{{ appointment.startTime | date:'dd/MM/yyyy HH:mm' }}</div>
                        </div>
                        <div class="appointment-card-body">
                            <p><strong>Motivo:</strong> {{ getReasonLabel(appointment.reason) }}</p>
                            <p><strong>Cliente:</strong> {{ appointment.clientName || 'No especificado' }}</p>
                            <p><strong>Estado:</strong> 
                                <span class="status-badge-card" [style.background-color]="getStatusColor(appointment.status)">
                                    {{ getStatusLabel(appointment.status) }}
                                </span>
                            </p>
                            @if (appointment.hasDiagnosis) {
                                <p class="has-diagnosis">✓ Tiene diagnóstico</p>
                            }
                        </div>
                    </article>
                }
            </div>

            <!-- Botón Ver más -->
            @if (hasMoreItems) {
                <div class="load-more-container">
                    <button class="btn-load-more" (click)="loadMore()">
                        Ver más
                    </button>
                </div>
            }
        }
    </main>
</section>

<!-- Modal de detalles -->
@if (showDetailsModal && selectedAppointment) {
  <div class="modal-overlay" (click)="closeDetailsModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Detalles de la Cita</h2>
        <button class="btn-close" (click)="closeDetailsModal()">×</button>
      </div>

      <div class="modal-body">
        <div class="appointment-details-section">
          <h3>Información de la Cita</h3>
          <div class="detail-row">
            <span class="detail-label">Mascota:</span>
            <span class="detail-value">{{ getFullPetDisplay(selectedAppointment) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Cliente:</span>
            <span class="detail-value">{{ selectedAppointment.clientName || 'No especificado' }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Fecha:</span>
            <span class="detail-value">{{ formatDate(selectedAppointment.startTime) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Horario:</span>
            <span class="detail-value">{{ formatTime(selectedAppointment.startTime) }} - {{ formatTime(selectedAppointment.endTime) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Doctor:</span>
            <span class="detail-value">{{ selectedAppointment.doctorName }} - {{ getSpecialityLabel(selectedAppointment.doctorSpeciality) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Motivo:</span>
            <span class="detail-value">{{ getReasonLabel(selectedAppointment.reason) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Estado:</span>
            <span class="detail-value status-badge" [style.background-color]="getStatusColor(selectedAppointment.status)">
              {{ getStatusLabel(selectedAppointment.status) }}
            </span>
          </div>
        </div>

        @if (selectedAppointment.hasDiagnosis) {
          @if (loadingDiagnosis) {
            <div class="loading-message">Cargando diagnóstico...</div>
          } @else if (diagnosisData) {
            <div class="diagnosis-section">
              <h3>Diagnóstico</h3>
              <div class="diagnosis-content">
                <p>{{ diagnosisData.diagnose }}</p>
              </div>

              <h3>Tratamiento</h3>
              <div class="treatment-content">
                <p>{{ diagnosisData.treatment }}</p>
              </div>

              <div class="diagnosis-footer">
                <button class="btn-view-diagnosis" (click)="openDiagnosisModal(selectedAppointment.diagnosisId)">
                  Ver diagnóstico completo
                </button>
              </div>
            </div>
          }
        } @else {
          <div class="no-diagnosis-section">
            @if (canCreateDiagnosis(selectedAppointment)) {
              <div class="no-diagnosis-message">
                <p>Esta cita no tiene diagnóstico registrado.</p>
                <p class="time-info">Puedes crear un diagnóstico hasta 1 hora después de que termine la cita.</p>
              </div>
              <div class="diagnosis-footer">
                <button class="btn-create-diagnosis" (click)="openCreateDiagnosisModal(selectedAppointment?.appointmentId ?? null)">
                  Crear diagnóstico
                </button>
              </div>
            } @else {
              <div class="no-diagnosis-message">
                <p>Esta cita no tiene diagnóstico registrado.</p>
                @if (selectedAppointment.status === Status.CANCELED) {
                  <p class="time-info">No se puede crear un diagnóstico para una cita cancelada.</p>
                } @else if (selectedAppointment.hasDiagnosis) {
                  <p class="time-info">Esta cita ya tiene un diagnóstico registrado.</p>
                } @else {
                  <p class="time-info">Ya no es posible crear un diagnóstico para esta cita (el tiempo permitido ha expirado o la cita aún no ha comenzado).</p>
                }
              </div>
            }
          </div>
        }
      </div>

      <div class="modal-footer">
        <button class="btn-close-modal" (click)="closeDetailsModal()">Cerrar</button>
      </div>
    </div>
  </div>
}
