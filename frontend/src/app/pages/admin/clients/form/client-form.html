<section id="client-container-all">

  <div class="client-wrapper">
    <div class="client-image">
      <img src="assets/images/client-logo.png" alt="Client Logo">
    </div>

    <form [formGroup]="clientForm" (ngSubmit)="onSubmit()">
      <h1>{{ isEditMode ? 'Editar Cliente' : 'Registrar Nuevo Cliente' }}</h1>

      @if (!isEditMode) {
        <div class="input-wrapper">
          <label for="username" class="input-label">Usuario</label>
          <input id="username" type="text" class="custom-input" formControlName="username" placeholder="Ingrese un nombre de usuario">
        </div>
        @if (clientForm.get('username')?.errors && (clientForm.get('username')?.touched || clientForm.get('username')?.dirty)) {
          <div class="error-message">
            @if (clientForm.get('username')?.hasError('required')) {
              <p class="error-msg">El usuario es obligatorio.</p>
            } @else if (clientForm.get('username')?.hasError('usernameExists')) {
              <p class="error-msg">El nombre de usuario ya existe. Por favor, elegí otro.</p>
            }
          </div>
        }
        @if (clientForm.get('username')?.pending) {
          <div class="error-message">
            <p class="error-msg" style="color: #666;">Verificando disponibilidad...</p>
          </div>
        }

        <div class="input-wrapper">
          <label for="password" class="input-label">Contraseña</label>
          <input id="password" type="password" class="custom-input" formControlName="password" placeholder="Ingrese una contraseña segura">
        </div>
        @if (clientForm.get('password')?.touched || clientForm.get('password')?.value) {
          <div class="password-requirements">
            <div class="requirement-item" [class.valid]="hasMinLength()" [class.invalid]="!hasMinLength()">
              <span class="requirement-icon">{{ hasMinLength() ? '✓' : '✗' }}</span>
              <span class="requirement-text">Debe tener al menos 8 caracteres</span>
            </div>
            <div class="requirement-item" [class.valid]="hasLetter()" [class.invalid]="!hasLetter()">
              <span class="requirement-icon">{{ hasLetter() ? '✓' : '✗' }}</span>
              <span class="requirement-text">Debe contener al menos una letra</span>
            </div>
            <div class="requirement-item" [class.valid]="hasNumber()" [class.invalid]="!hasNumber()">
              <span class="requirement-icon">{{ hasNumber() ? '✓' : '✗' }}</span>
              <span class="requirement-text">Debe contener al menos un número</span>
            </div>
            <div class="requirement-item" [class.valid]="hasMaxLength()" [class.invalid]="!hasMaxLength()">
              <span class="requirement-icon">{{ hasMaxLength() ? '✓' : '✗' }}</span>
              <span class="requirement-text">No puede exceder 50 caracteres</span>
            </div>
          </div>
        }
        @if (clientForm.get('password')?.hasError('required') && clientForm.get('password')?.touched) {
          <div class="error-message">
            <p class="error-msg">La contraseña es obligatoria.</p>
          </div>
        }

        <div class="input-wrapper">
        <label for="dni" class="input-label">DNI</label>
        <input id="dni" type="text" class="custom-input" formControlName="dni" placeholder="Ingrese el DNI">
      </div>
      @if (clientForm.get('dni')?.errors && (clientForm.get('dni')?.touched || clientForm.get('dni')?.dirty)) {
        <div class="error-message">
          @if (clientForm.get('dni')?.hasError('required')) {
            <p class="error-msg">El DNI es obligatorio.</p>
          } @else if (clientForm.get('dni')?.hasError('invalidDni')) {
            <p class="error-msg">El DNI solo puede contener números.</p>
          } @else if (clientForm.get('dni')?.hasError('invalidDniLength')) {
            <p class="error-msg">El DNI debe tener 7 u 8 dígitos.</p>
          } @else if (!isEditMode && clientForm.get('dni')?.hasError('dniExists')) {
            <p class="error-msg">Este DNI ya está registrado. Por favor, verificá los datos ingresados.</p>
          }
        </div>
      }

      <div class="input-wrapper">
        <label for="email" class="input-label">Email</label>
        <input id="email" type="email" class="custom-input" formControlName="email" placeholder="Ingrese el email">
      </div>
      @if (clientForm.get('email')?.errors && (clientForm.get('email')?.touched || clientForm.get('email')?.dirty)) {
        <div class="error-message">
          @if (clientForm.get('email')?.hasError('required')) {
            <p class="error-msg">El email es obligatorio.</p>
          } @else if (clientForm.get('email')?.hasError('email')) {
            <p class="error-msg">Debe ingresar un email válido.</p>
          } @else if (!isEditMode && clientForm.get('email')?.hasError('emailExists')) {
            <p class="error-msg">Este email ya está registrado. Por favor, usá otro email.</p>
          }
        </div>
      }
      
      }

      <div class="input-wrapper">
        <label for="name" class="input-label">Nombre</label>
        <input id="name" type="text" class="custom-input" formControlName="name" placeholder="Ingrese el nombre">
      </div>
      @if (clientForm.get('name')?.errors && clientForm.get('name')?.touched) {
        <div class="error-message">
          @if (clientForm.get('name')?.hasError('required')) {
            <p class="error-msg">El nombre es obligatorio.</p>
          } @else if (clientForm.get('name')?.hasError('invalidName')) {
            <p class="error-msg">El nombre solo puede contener letras, espacios, ñ y tildes.</p>
          } @else if (clientForm.get('name')?.hasError('minlength') || clientForm.get('name')?.hasError('maxlength')) {
            <p class="error-msg">El nombre debe tener entre 2 y 50 caracteres.</p>
          }
        </div>
      }

      <div class="input-wrapper">
        <label for="surname" class="input-label">Apellido</label>
        <input id="surname" type="text" class="custom-input" formControlName="surname" placeholder="Ingrese el apellido">
      </div>
      @if (clientForm.get('surname')?.errors && clientForm.get('surname')?.touched) {
        <div class="error-message">
          @if (clientForm.get('surname')?.hasError('required')) {
            <p class="error-msg">El apellido es obligatorio.</p>
          } @else if (clientForm.get('surname')?.hasError('invalidName')) {
            <p class="error-msg">El apellido solo puede contener letras, espacios, ñ y tildes.</p>
          } @else if (clientForm.get('surname')?.hasError('minlength') || clientForm.get('surname')?.hasError('maxlength')) {
            <p class="error-msg">El apellido debe tener entre 2 y 50 caracteres.</p>
          }
        </div>
      }

      <div class="input-wrapper">
        <label for="phone" class="input-label">Teléfono</label>
        <input id="phone" type="text" class="custom-input" formControlName="phone" placeholder="Ingrese el teléfono">
      </div>
      @if (clientForm.get('phone')?.errors && (clientForm.get('phone')?.touched || clientForm.get('phone')?.dirty)) {
        <div class="error-message">
          @if (clientForm.get('phone')?.hasError('required')) {
            <p class="error-msg">El teléfono es obligatorio.</p>
          } @else if (clientForm.get('phone')?.hasError('invalidPhone')) {
            <p class="error-msg">El teléfono solo puede contener números.</p>
          } @else if (clientForm.get('phone')?.hasError('invalidPhoneLength')) {
            <p class="error-msg">El teléfono debe tener entre 9 y 20 dígitos.</p>
          } @else if (!isEditMode && clientForm.get('phone')?.hasError('phoneExists')) {
            <p class="error-msg">Este teléfono ya está registrado. Por favor, usá otro.</p>
          }
        </div>
      }
      @if (!isEditMode && clientForm.get('phone')?.pending) {
        <div class="error-message">
          <p class="error-msg" style="color: #666;">Verificando disponibilidad...</p>
        </div>
      }

      
      @if (!isEditMode && clientForm.get('dni')?.pending) {
        <div class="error-message">
          <p class="error-msg" style="color: #666;">Verificando disponibilidad...</p>
        </div>
      }

      
      @if (!isEditMode && clientForm.get('email')?.pending) {
        <div class="error-message">
          <p class="error-msg" style="color: #666;">Verificando disponibilidad...</p>
        </div>
      }

      @if (!isEditMode) {
        <div class="input-wrapper checkbox-wrapper">
          <label class="checkbox-label">
            <input type="checkbox" formControlName="foundation" class="checkbox-input">
            <span>¿Es una fundación?</span>
          </label>
        </div>
      }

      <button class="register-btn" type="submit" [disabled]="clientForm.invalid || isLoading">
        @if (isLoading) {
                Guardando...
            } @else {
                {{ isEditMode ? 'Guardar Cambios' : 'Registrar Cliente' }}
            }
        
      </button>
    </form>
  </div>

</section>

